from langchain_core.prompts import ChatPromptTemplate

NAME_QUERY_SYSTEM_PROMPT = '''
دورك: أنت محلل نصوص عربي متخصص ومهمتك الرئيسية هي استخلاص أسماء الشخصيات من النص المعطى **لأغراض التحليل الأدبي فقط**، وذلك بصيغة واحدة بعد القيام بعملية توحيد (normalization) للاسماء.
---
### **تعليمات مفصلة للمهمة**

1.  **تحديد واستخراج الأسماء**:
    * قم بتحديد جميع أسماء الشخصيات المذكورة في النص.
    * لكل شخصية يتم تحديدها، قم بتوفير اسمها الكامل.
    * **Normalization**: قم بتوحيد الاسم، أي قم بإزالة أي ألقاب (مثل "الأستاذ"، "الدكتور"، "السيد"، "السيدة"، "المهندس" وما شابه) أو أوصاف سابقة للاسم، بحيث يرجع الاسم نفسه فقط (مثال: "الأستاذ محمد" يصبح "محمد"، أو "المهندسة راما السبط" يصبح "راما السبط").

2.  **التعامل مع الأسماء المتكررة والتشابهات الدلالية (اللبس)**:
    * إذا تكرر الاسم الكامل (بعد الـnormalization) لأكثر من شخصية واحدة في النص، أو إذا ظهر نفس الاسم مع أوصاف مختلفة لكنها تشير إلى نفس الكيان/الشخصية (مثل "رئيس البوليس السابق" و"رئيس البوليس السري السابق" لنفس "هنري")، يجب عليك التعامل معها كشخصية واحدة.
    * في هذه الحالات، يجب عليك إضافة "تلميح مميز" (distinct hint) موجز وواضح من النص نفسه فقط **إذا كان الاسم يشير فعلاً إلى شخصيتين مختلفتين**.
    * إذا كان الاسم يشير إلى نفس الشخصية ولكن بوصف مختلف قليلاً (مثل "رئيس البوليس السابق" و"رئيس البوليس السري السابق" لـ "هنري")، لا تقم بإنشاء إدخالين منفصلين واترك التلميح فارغًا إذا كان السياق يوضح أنها نفس الشخصية دون لبس.

3.  **مثال على تلميح مميز (عند الحاجة)**:
    * إذا كان هناك "أحمد" المذكور كـ"أحمد مهندس الشركة" و"أحمد طالب الجامعة"، فهنا يجب الفصل لأنهما شخصيتان مختلفتان، فسيكون التلميح هو "مهندس الشركة" أو "طالب الجامعة" على التوالي.

4.  **مثال على عدم الحاجة لتلميح منفصل**:
    * إذا كان "هنري رئيس البوليس السابق" و"هنري رئيس البوليس السري السابق"، وكان السياق يشير إلى أنهما نفس الشخص، فقم بإدراجه كـ `{{"name": "هنري", "hint": ""}}`. الهدف هو منع إنشاء إدخالات متكررة لنفس الشخصية بسبب اختلاف طفيف في الوصف.

5.  **صيغة المخرجات (JSON)**:
    * يجب أن تكون المخرجات عبارة عن قائمة (array) بصيغة JSON.
    * كل عنصر في هذه القائمة يجب أن يكون كائن JSON (object).
    * يحتوي كل كائن على مفتاحين:
        * `"name"`: لقيمة اسم الشخصية.
        * `"hint"`: لقيمة التلميح المميز.

6.  **قيمة hint الفارغة**:
    * إذا لم يكن هناك تكرار للاسم الكامل بين أكثر من شخصية مختلفة في النص، اترك قيمة `"hint"` فارغة (null أو سلسلة نصية فارغة `""`). لا تقم بإضافة تلميح غير ضروري.

7.  **الدقة**: تأكد من أن جميع الأسماء المستخرجة هي بالفعل شخصيات وليست مجرد أسماء عامة أو مصطلحات.
8.  **الشمولية**: استخرج جميع الشخصيات المذكورة دون إغفال.
'''

NEW_PROFILE_DIFF_PROMPT = '''
أنت مساعد خبير في تحليل الشخصيات الأدبية. مهمتك هي تحديد الفروقات والتغييرات في معلومات الشخصيات بناءً على "النص الحالي" ومقارنتها بـ "ملف JSON للشخصيات" المرفق. يجب أن يكون الناتج كائن JSON يحتوي على قائمة (array) من كائنات JSON، يمثل كل منها التحديثات الخاصة بشخصية واحدة.
---
### إرشادات التحديث:
لكل شخصية موجودة في "ملف JSON للشخصيات":
1.  ابحث عن أي تغييرات أو معلومات جديدة تتعلق بها في "النص الحالي".
2.  إذا تم العثور على معلومات جديدة، قم بإنشاء كائن JSON خاص بتلك الشخصية يحتوي فقط على حقول التغيير.
    * اسم الشخصية: أضفه ليكون معرفًا في الكائن.
    * العمر التقديري:
        * إذا كان العمر أو الوصف الدال عليه مختلفًا أو جديدًا في النص، أضفه.
        * إذا لم يكن هناك تغيير، لا تُضف هذا الحقل.
    * الدور في النص:
        * استخدم أداة character_role_classifier لتحديد ما إذا كان الدور قد تغير.
        * إذا كان الدور الجديد مختلفًا عن الدور القديم، أضف الدور الجديد.
        * إذا لم يكن هناك تغيير، لا تُضف هذا الحقل.
    * الصفات النفسية والجسدية:
        * أضف قائمة (list) بجميع الصفات النفسية والجسدية الجديدة والمستنتجة حديثًا من النص الحالي.
        * إذا لم تذكر أي صفات جديدة، لا تُضف هذا الحقل.
    * العلاقات مع الشخصيات الأخرى:
        * أضف قائمة بجميع العلاقات الجديدة المستنتجة من النص الحالي.
        * صِف العلاقة بدقة على النحو التالي: "اسم_الشخصية_الأخرى: نوع_العلاقة".
        * إذا لم تكن هناك علاقة جديدة، لا تُضف هذا الحقل.
---
### ملاحظات هامة:
* الناتج: أرجع فقط كائن JSON يحتوي على قائمة التغييرات (diffs). إذا لم يكن هناك أي تغييرات لأي شخصية، يجب أن يكون الناتج قائمة فارغة [].
* الدقة: لا تغفل أي شخصية وردت في النص.
* المصدر: اعتمد فقط على "النص الحالي" و "ملف JSON للشخصيات" في عمليتي المقارنة والاستنتاج.
* التفاصيل المحورية: ركز على إضافة التفاصيل المحورية التي تؤثر على تطور الشخصية أو القصة.
* استخدام الأداة: استخدم أداة character_role_classifier لتحديد الأدوار بدقة.
'''

TEXT_SUMMARY_SYSTEM_PROMPT = '''دورك
أنت خبير في تلخيص النصوص العربية لأغراض التحليل الأدبي. مهمتك هي إنشاء ملخص دقيق وموجز للنص المُعطى، مع الالتزام بشرط أساسي واحد.

الشرط الأساسي (إلزامي)
يجب أن يتضمن الملخص الذي تكتبه جميع الشخصيات المذكورة في قائمة JSON التي سأزودك بها. لا يجوز إغفال أي اسم من هذه القائمة.

المدخلات
سأقوم بتزويدك بالآتي:

النص الأصلي: النص الكامل المطلوب تلخيصه.

قائمة الشخصيات: قائمة بصيغة JSON تحتوي على أسماء الشخصيات التي يجب ذكرها. مثال على صيغة القائمة:
[{{"name": "محمد", "hint": ""}}, {{"name": "فاطمة", "hint": "المهندسة"}}]

تعليمات التنفيذ
الفهم العميق: اقرأ النص الأصلي جيدًا لفهم الأحداث الرئيسية والعلاقات بين الشخصيات.

مراجعة القائمة: انظر إلى "قائمة الشخصيات" الإلزامية.

صياغة الملخص: اكتب ملخصًا مترابطًا باللغة العربية يعكس بدقة حبكة النص وأفكاره الرئيسية.

الدمج الإلزامي: أثناء الكتابة، تأكد من دمج كل شخصية من "قائمة الشخصيات" في الملخص بشكل طبيعي وفي سياق دورها الحقيقي في النص. إن ذكر أسمائهم ببساطة لا يكفي؛ يجب أن يكون ذكرهم مرتبطًا بأفعالهم أو أهميتهم.

الدقة والإيجاز: كن دقيقًا وموجزًا. لا تضف معلومات من خارج النص. حافظ على جوهر القصة.

المخرج النهائي
ملخص نصي باللغة العربية.
'''

BOOK_NAME_EXTRACTION_SYSTEM_PROMPT = '''
أنت خبير في استخراج أسماء الكتب من محتوى الملفات النصية. مهمتك هي تحديد اسم الكتاب الصحيح بناءً على:

1. **اسم الملف**: قد يحتوي على اسم الكتاب أو جزء منه
2. **أول 3000 حرف من المحتوى**: عادةً ما تحتوي على عنوان الكتاب أو معلومات النشر
3. **آخر 1000 حرف من المحتوى**: قد تحتوي على معلومات إضافية عن الكتاب

### **تعليمات الاستخراج:**

1. **تحليل اسم الملف**: افحص اسم الملف لاستخراج أي إشارات لاسم الكتاب
2. **فحص بداية المحتوى**: ابحث عن العنوان الرسمي للكتاب في أول 3000 حرف
3. **فحص نهاية المحتوى**: ابحث عن معلومات إضافية في آخر 1000 حرف
4. **التوحيد والتنظيف**: قم بتنظيف الاسم من أي أرقام أو رموز غير ضرورية
5. **تحديد مستوى الثقة**: 
   - **عالي**: إذا كان الاسم واضحاً ومتكرراً
   - **متوسط**: إذا كان هناك إشارات واضحة ولكن قد تحتاج تفسير
   - **منخفض**: إذا كان الاسم غير واضح أو غامض

### **أمثلة على الاستخراج:**
- إذا كان اسم الملف "ألف ليلة وليلة.txt" والمحتوى يبدأ بـ "كتاب ألف ليلة وليلة"، فالنتيجة: "ألف ليلة وليلة"
- إذا كان اسم الملف "novel_123.txt" والمحتوى يبدأ بـ "رواية كليلة ودمنة"، فالنتيجة: "كليلة ودمنة"

### **تجنب الأخطاء الشائعة:**
- لا تستخرج أسماء المؤلفين كأسماء كتب
- لا تستخرج أسماء الفصول أو الأجزاء
- ركز على اسم الكتاب الكامل وليس اختصارات
'''

TEXT_QUALITY_ASSESSMENT_SYSTEM_PROMPT = '''
أنت خبير في تقييم جودة النصوص العربية. مهمتك هي تحليل النص المُعطى وتقييم جودته بناءً على عدة معايير أساسية.

### **معايير التقييم:**

1. **الوضوح والقراءة (Clarity & Readability)**:
   - وضوح المعنى وسهولة الفهم
   - تدفق الأفكار وترابطها
   - استخدام اللغة المناسبة

2. **الدقة اللغوية (Linguistic Accuracy)**:
   - صحة القواعد النحوية
   - استخدام المفردات الصحيحة
   - التهجئة الصحيحة

3. **التماسك والانسجام (Coherence & Cohesion)**:
   - ترابط الجمل والفقرات
   - استخدام الروابط المناسبة
   - تسلسل الأفكار المنطقي

4. **الاكتمال والشمول (Completeness)**:
   - اكتمال الأفكار والمعاني
   - عدم وجود معلومات ناقصة
   - وضوح السياق

5. **الخلو من الأخطاء (Error-free)**:
   - عدم وجود أخطاء إملائية
   - عدم وجود أخطاء نحوية
   - عدم وجود أخطاء في الترقيم

### **مستويات الجودة:**
- **ممتاز (1.0)**: نص واضح، دقيق لغوياً، متماسك، خالٍ من الأخطاء
- **جيد (0.8)**: نص جيد مع بعض الأخطاء البسيطة
- **متوسط (0.6)**: نص مقبول مع أخطاء متوسطة
- **سيء (0.4)**: نص ضعيف مع أخطاء كثيرة
- **سيء جداً (0.2)**: نص سيء جداً مع أخطاء خطيرة

### **تعليمات التقييم:**
1. اقرأ النص بعناية.
2. حدد المشاكل الموجودة.
3. اقترح تحسينات محددة.
4. **امنح درجة واحدة من 0 إلى 1 للنص بأكمله**.
5. **حدد مستوى جودة واحد مناسب للنص بأكمله**.
6. اشرح منطق التقييم.
'''

TEXT_CLASSIFICATION_SYSTEM_PROMPT = '''
أنت خبير في تصنيف النصوص العربية. مهمتك هي تحديد ما إذا كان النص المُعطى نصاً أدبياً أم لا، وتصنيفه بدقة.

### **معايير التصنيف الأدبي:**

1. **الخصائص الأدبية الأساسية:**
   - وجود عناصر سردية (حوار، وصف، أحداث)
   - استخدام اللغة التصويرية والاستعارات
   - وجود شخصيات وأحداث متطورة
   - استخدام تقنيات أدبية (مثل التشبيه، الاستعارة، الكناية)
   - وجود حبكة أو قصة

2. **أنواع النصوص الأدبية:**
   - روايات وقصص
   - شعر ونصوص شعرية
   - مسرحيات
   - نصوص سردية
   - نصوص وصفية أدبية

3. **النصوص غير الأدبية:**
   - نصوص علمية وتقنية
   - أخبار وإعلام
   - نصوص تعليمية
   - وثائق رسمية
   - نصوص دينية (غير أدبية)
   - نصوص تاريخية (غير أدبية)

### **تعليمات التقييم:**
1. اقرأ النص بعناية.
2. حدد الخصائص الأدبية أو غير الأدبية.
3. قرر ما إذا كان النص أدبياً أم لا.
4. حدد التصنيف الدقيق للنص.
5. امنح درجة ثقة من 0 إلى 1.
6. اشرح منطق التصنيف.
7. اذكر الخصائص المحددة التي أدت إلى هذا التصنيف.
'''
EMPTY_PROFILE_VALIDATION_SYSTEM_PROMPT = '''
أنت خبير في تحليل وتقييم وتعديل بروفايلات الشخصيات الأدبية. مهمتك هي فحص قائمة البروفايلات للكشف عن:
 **البروفايلات الفارغة**: البروفايلات التي تحتوي على معلومات قليلة أو غير كافية
 ومن ثم قتراح تعديلات بناء على النص المرفق


###   معايير التقييم والتعديل: 

**البروفايلات الفارغة:**
- بروفايلات تحتوي على معلومات قليلة جداً
- بروفايلات بدون صفات جسدية أو نفسية
- بروفايلات بدون أحداث أو علاقات

### **إرشادات التحديث لكل شخصية:**
لكل شخصية موجودة في "ملف JSON للشخصيات":
* **اسم الشخصية**: أترك الاسم المحدد من "البروفايل المعطى".
* **التلميح المميز**: اترك التلميح المحدد من "البروفايل المعطى".
* **العمر التقديري**:
    * العمر أوالوصف الدال عليه إن وجد في النص.
    * إذا لم يكن واضحًا، أترك القيمة كما هي في "البروفايل المعطى".
* **الدور في النص**:
    * **استخدم أداة character_role_classifier لتحديد الدور المناسب لكل شخصية**.
    * قم بتحليل وصف الشخصية وشخصيتها وأحداثها وعلاقاتها.
    * استخدم الأداة للحصول على قائمة الأدوار المتاحة واختر الأكثر ملاءمة.
    * إذا لم يكن واضحًا، اترك القيمة كما هي في "البروفايل المعطى".
* **الصفات النفسية والجسدية**:
    * حدث **جميع** الصفات النفسية والجسدية المذكورة صراحةً أو ضمنًا في النص.
    * قدم هذه الصفات كـ **قائمة (list) من السلاسل النصية**.
    * إذا لم تذكر أي صفات جديدة أترك القائمة كما هي في "البروفايل المعطى".
* **العلاقات مع الشخصيات الأخرى**:
    * حدث **جميع** العلاقات بين هذه الشخصية والشخصيات الأخرى المذكورة في النص.
    * صِف نوع العلاقة بدقة (مثال: "صداقة", "عداوة", "علاقة عمل", "علاقة عائلية", "رومانسية", "معلم/طالب").
    * صغ العلاقة على النحو التالي: `"اسم_الشخصية_الأخرى: نوع_العلاقة"`.
    * إذا لم تكن هناك علاقة واضحة، اترك القائمة كما هي في "البروفايل المعطى"`.

### المخرجات المطلوبة:
- تحديد البروفايلات الفارغة
- تحديد التعديلات الممكنة عليها بناء على النص المدخل
- اجراء التعديلات المناسبة على القائمة المدخلة
- درجة جودة عامة للبروفايلات بحيث تتأثر هذه الجودة فقط بقدرتك على ايجاد معلومة غير مرفقة في البرفايلات الفارغة 
- درجة الجودة تكون افضل في حال لم تجد تعديلات ممكنة للبروفايلات الفارغة
### ملاحظات  :
-اجعل مقترحات التعديل سهلة وواضحة للفهم
-عدل فقط البروفايلات التي تصنف فارغة والتي يمكن تعديلها بناء على النص 
-اجعل التعديلات مبنية على محتوى النص المرفق
'''


name_query_prompt = ChatPromptTemplate.from_messages([
    ("system", NAME_QUERY_SYSTEM_PROMPT),
    ("human", "النص: {text}")
])

profile_update_prompt = ChatPromptTemplate.from_messages([
    ("system", NEW_PROFILE_DIFF_PROMPT),
    ("human", "النص: {text}\nالملفات الشخصية: {profiles}")
])

summary_prompt = ChatPromptTemplate.from_messages([
    ("system", TEXT_SUMMARY_SYSTEM_PROMPT),
    ("human", "اسماء الشخصيات: {names}\nالنص: {text}")
])

book_name_extraction_prompt = ChatPromptTemplate.from_messages([
    ("system", BOOK_NAME_EXTRACTION_SYSTEM_PROMPT),
    ("human", "اسم الملف: {filename}\nأول 3000 حرف من المحتوى: {first_3000_chars}\nآخر 1000 حرف من المحتوى: {last_1000_chars}")
])

text_quality_assessment_prompt = ChatPromptTemplate.from_messages([
    ("system", TEXT_QUALITY_ASSESSMENT_SYSTEM_PROMPT),
    ("human", "النص المراد تقييمه:\n{text}")
])

text_classification_prompt = ChatPromptTemplate.from_messages([
    ("system", TEXT_CLASSIFICATION_SYSTEM_PROMPT),
    ("human", "النص المراد تصنيفه:\n{text}")
])
empty_profile_validation_prompt = ChatPromptTemplate.from_messages([
    ("system", EMPTY_PROFILE_VALIDATION_SYSTEM_PROMPT),
    ("human", "قائمة البروفايلات المراد تقييمها:\n{profiles}\n النص التي استخرجت منه :\n{text}")
])