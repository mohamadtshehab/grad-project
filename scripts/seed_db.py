#!/usr/bin/env python
"""
Database seeding script for API testing
Creates realistic test data for all models in the system
"""

import os
import sys
import django
from django.core.files.base import ContentFile
from django.core.files.storage import default_storage
from faker import Faker
import random
from datetime import datetime, timedelta

# Add the project root to the Python path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Setup Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'graduation_backend.settings')
django.setup()

# Now import Django models
from user.models import User
from books.models import Book
from chunks.models import Chunk
from characters.models import Character, ChunkCharacter, CharacterRelationship

fake = Faker(['en_US', 'ar_SA'])  # English and Arabic locales

class DatabaseSeeder:
    def __init__(self):
        self.users = []
        self.books = []
        self.chunks = []
        self.characters = []
        
        # Sample Arabic text chunks for realistic book content
        self.arabic_text_samples = [
            "ูู ููู ูู ุงูุฃูุงูุ ูุงู ููุงู ุฑุฌู ูุฏุนู ุฃุญูุฏ ูุนูุด ูู ูุฑูุฉ ุตุบูุฑุฉ. ูุงู ุฃุญูุฏ ุฑุฌูุงู ุทูุจ ุงูููุจุ ูุญุจ ูุณุงุนุฏุฉ ุงูุขุฎุฑูู. ูู ุตุจุงุญ ุฃุญุฏ ุงูุฃูุงูุ ุงุณุชููุธ ุฃุญูุฏ ูุจูุฑุงู ูุฎุฑุฌ ุฅูู ุงูุญุฏููุฉ.",
            "ุงูุชูุช ูุงุทูุฉ ุจุตุฏููุชูุง ูุฑูู ูู ุงูุณูู. ูุงูุช ูุงุทูุฉ ุชุจุญุซ ุนู ูุฏูุฉ ูุงุจูุชูุง ุงูุตุบูุฑุฉ ุณุงุฑุฉ. ูุฑูู ุงูุชุฑุญุช ุนูููุง ุฃู ุชุฐูุจ ุฅูู ุงูููุชุจุฉ ูุชุดุชุฑู ููุง ูุชุงุจุงู ุฌูููุงู.",
            "ูุงู ุนูู ุทุงูุจุงู ูุฌุชูุฏุงู ูู ุงูุฌุงูุนุฉ. ูุฏุฑุณ ุงูุฃุฏุจ ุงูุนุฑุจู ููุญูู ุจุฃู ูุตุจุญ ูุงุชุจุงู ูุดููุฑุงู ูููุงู ูุง. ูู ุงููุณุงุกุ ูุฌูุณ ุนูู ูู ููุชุจุชู ุงูุตุบูุฑุฉ ูููุชุจ ุงููุตุต ูุงูุดุนุฑ.",
            "ุนุงุด ูุญูุฏ ูุน ุฌุฏู ุงูุญููู ูู ุจูุช ูุฏูู ุจุฌุงูุจ ุงูููุฑ. ูุงู ุงูุฌุฏ ูุญูู ููุญูุฏ ูุตุตุงู ุฑุงุฆุนุฉ ุนู ุงููุงุถูุ ููุงู ูุญูุฏ ูุณุชูุน ุจุดุบู ุฅูู ูุฐู ุงูุญูุงูุงุช ุงููุซูุฑุฉ.",
            "ูู ุงููุฏููุฉ ุงููุจูุฑุฉุ ูุงูุช ููุงู ุงูุฑุฃุฉ ุชุฏุนู ุฎุฏูุฌุฉ ุชุนูู ุทุจูุจุฉ. ูุงูุช ุฎุฏูุฌุฉ ูุนุฑููุฉ ุจุทูุจุชูุง ููุณุงุนุฏุชูุง ููููุฑุงุก. ูู ูููุ ุชุฐูุจ ุฅูู ุงูุนูุงุฏุฉ ูุชุนุงูุฌ ุงููุฑุถู ุจุญุจ ูุฅุฎูุงุต.",
        ]
        
        # Character names and data for Arabic context
        self.character_templates = [
            {
                "name": "ุฃุญูุฏ",
                "age": "35",
                "role": "ุงูุจุทู",
                "physical_characteristics": ["ุทููู ุงููุงูุฉ", "ุฃุณูุฑ ุงูุจุดุฑุฉ", "ุนููู ุจููุฉ"],
                "personality": "ุทูุจ ุงูููุจุ ุดุฌุงุนุ ูุณุงุนุฏ ููุขุฎุฑูู",
                "events": ["ุฎุฑุฌ ุฅูู ุงูุญุฏููุฉ", "ุณุงุนุฏ ุฌุงุฑู ุงููุฑูุถ", "ูุฌุฏ ููุฒุงู ูุฏูููุงู"],
                "relationships": ["ุฒูุฌ ูุงุทูุฉ", "ุตุฏูู ุนูู"],
                "aliases": ["ุฃุจู ูุญูุฏ", "ุงูุฑุฌู ุงูุทูุจ"]
            },
            {
                "name": "ูุงุทูุฉ",
                "age": "30",
                "role": "ุงูุฒูุฌุฉ",
                "physical_characteristics": ["ูุชูุณุทุฉ ุงูุทูู", "ุดุนุฑ ุฃุณูุฏ", "ุนููู ุฎุถุฑุงุก"],
                "personality": "ุญูููุฉุ ุฐููุฉุ ููุชูุฉ ุจุงูุฃุทูุงู",
                "events": ["ุฐูุจุช ุฅูู ุงูุณูู", "ุงูุชูุช ุจูุฑูู", "ุงุดุชุฑุช ูุฏูุฉ ูุงุจูุชูุง"],
                "relationships": ["ุฒูุฌุฉ ุฃุญูุฏ", "ุตุฏููุฉ ูุฑูู", "ุฃู ุณุงุฑุฉ"],
                "aliases": ["ุฃู ุณุงุฑุฉ", "ุงูุฃู ุงูุญูููุฉ"]
            },
            {
                "name": "ุนูู",
                "age": "22",
                "role": "ุงูุทุงูุจ",
                "physical_characteristics": ["ูุญูู", "ุทููู", "ูุฑุชุฏู ูุธุงุฑุงุช"],
                "personality": "ูุฌุชูุฏุ ุทููุญุ ูุญุจ ููุฃุฏุจ",
                "events": ["ูุฏุฑุณ ูู ุงูุฌุงูุนุฉ", "ููุชุจ ุงููุตุต", "ูุญูู ุจุฃู ูุตุจุญ ูุงุชุจุงู"],
                "relationships": ["ุตุฏูู ุฃุญูุฏ", "ุทุงูุจ ุนูุฏ ุงูุฃุณุชุงุฐ ูุญููุฏ"],
                "aliases": ["ุงูุทุงูุจ ุงููุฌุชูุฏ", "ุงููุงุชุจ ุงูุดุงุจ"]
            },
            {
                "name": "ูุฑูู",
                "age": "28",
                "role": "ุงูุตุฏููุฉ",
                "physical_characteristics": ["ูุตูุฑุฉ ุงููุงูุฉ", "ุดุนุฑ ุจูู", "ุงุจุชุณุงูุฉ ุฌูููุฉ"],
                "personality": "ูุฑุญุฉุ ูุดูุทุฉุ ูุญุจุฉ ููุชุณูู",
                "events": ["ุงูุชูุช ุจูุงุทูุฉ", "ูุตุญุชูุง ุจุดุฑุงุก ูุชุงุจ", "ุฐูุจุช ูุนูุง ุฅูู ุงูููุชุจุฉ"],
                "relationships": ["ุตุฏููุฉ ูุงุทูุฉ", "ุฌุงุฑุฉ ุฎุฏูุฌุฉ"],
                "aliases": ["ุงููุฑุฃุฉ ุงููุฑุญุฉ", "ุงูุตุฏููุฉ ุงููููุฉ"]
            },
            {
                "name": "ุฎุฏูุฌุฉ",
                "age": "40",
                "role": "ุงูุทุจูุจุฉ",
                "physical_characteristics": ["ุฃูููุฉ ุงููุธูุฑ", "ุดุนุฑ ูุตูุฑ", "ุนููู ุฐููุฉ"],
                "personality": "ุญูููุฉุ ุทูุจุฉุ ูุฎูุตุฉ ูู ุนูููุง",
                "events": ["ุชุนุงูุฌ ุงููุฑุถู", "ุชุณุงุนุฏ ุงูููุฑุงุก", "ุชุนูู ูู ุงูุนูุงุฏุฉ"],
                "relationships": ["ุฌุงุฑุฉ ูุฑูู", "ุทุจูุจุฉ ุงูุนุงุฆูุฉ"],
                "aliases": ["ุงูุทุจูุจุฉ ุงูุทูุจุฉ", "ุงูุญูููุฉ"]
            }
        ]

    def clear_database(self):
        """Clear all existing data"""
        print("๐๏ธ  Clearing existing data...")
        CharacterRelationship.objects.all().delete()
        ChunkCharacter.objects.all().delete()
        Character.objects.all().delete()
        Chunk.objects.all().delete()
        Book.objects.all().delete()
        User.objects.exclude(is_superuser=True).delete()  # Keep superuser
        print("โ Database cleared!")

    def create_users(self, count=10):
        """Create test users"""
        print(f"๐ฅ Creating {count} users...")
        
        for i in range(count):
            user = User.objects.create_user(
                email=fake.email(),
                name=fake.name(),
                first_name=fake.first_name(),
                last_name=fake.last_name(),
                password='testpass123',
                is_active=True
            )
            self.users.append(user)
            
        print(f"โ Created {len(self.users)} users!")

    def create_books(self, count=15):
        """Create test books"""
        print(f"๐ Creating {count} books...")
        
        book_titles = [
             "ุงูุทุฑูู", "ุจูู ุงููุตุฑูู", "ูุตุฑ ุงูุดูู", "ุงูุณูุฑูุฉ",
            "ุฃููุงุฏ ุญุงุฑุชูุง", "ุงูุญุฑุงููุด", "ููุญูุฉ ุงูุญุฑุงููุด", "ุงููุฑูู", "ุงููุฑุงูุง",
            "ุญุฏูุซ ุงูุตุจุงุญ ูุงููุณุงุก", "ุฃุตุฏุงุก ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ", "ุงูุจุงูู ูู ุงูุฒูู ุณุงุนุฉ",
            "ุฑุญูุฉ ุงุจู ูุทููุฉ", "ููุงูู ุฃูู ูููุฉ"
        ]
        
        authors = [
            "ูุฌูุจ ูุญููุธ", "ููุณู ุฅุฏุฑูุณ", "ุฅุญุณุงู ุนุจุฏ ุงููุฏูุณ", "ุชูููู ุงูุญููู",
            "ุทู ุญุณูู", "ุนุจุงุณ ูุญููุฏ ุงูุนูุงุฏ", "ูุตุทูู ุตุงุฏู ุงูุฑุงูุนู"
        ]
        
        for i in range(count):
            # Create a dummy text file
            book_content = "\n\n".join(random.choices(self.arabic_text_samples, k=10))
            file_content = ContentFile(book_content.encode('utf-8'))
            
            title = random.choice(book_titles) if i < len(book_titles) else fake.sentence(nb_words=3)
            filename = f"book_{i+1}.txt"
            
            book = Book.objects.create(
                title=title,
                author=random.choice(authors),
                description=fake.text(max_nb_chars=200),
                user_id=random.choice(self.users)
            )
            
            # Save the file
            book.file.save(filename, file_content, save=True)
            self.books.append(book)
            
        print(f"โ Created {len(self.books)} books!")

    def create_chunks(self):
        """Create text chunks for each book"""
        print("๐ Creating text chunks...")
        
        for book in self.books:
            # Create 5-10 chunks per book
            chunk_count = random.randint(5, 10)
            
            for i in range(chunk_count):
                chunk_text = random.choice(self.arabic_text_samples)
                # Add some variation to the text
                chunk_text += " " + fake.text(max_nb_chars=300)
                
                chunk = Chunk.objects.create(
                    chunk_text=chunk_text,
                    chunk_number=i + 1,
                    book_id=book,
                    start_position=i * 500,
                    end_position=(i + 1) * 500,
                    word_count=len(chunk_text.split())
                )
                self.chunks.append(chunk)
                
        print(f"โ Created {len(self.chunks)} chunks!")

    def create_characters(self):
        """Create characters for books"""
        print("๐ค Creating characters...")
        
        for book in self.books:
            # Create 3-5 characters per book
            character_count = random.randint(3, 5)
            book_characters = []
            
            for i in range(character_count):
                template = random.choice(self.character_templates)
                
                # Add some variation to avoid exact duplicates
                character_data = {
                    "name": template["name"] + (f" {i+1}" if i > 0 else ""),
                    "age": str(random.randint(20, 60)),
                    "role": template["role"],
                    "physical_characteristics": template["physical_characteristics"][:],
                    "personality": template["personality"],
                    "events": random.choices(template["events"], k=random.randint(2, 4)),
                    "relationships": [],  # Will be filled later
                    "aliases": template["aliases"][:]
                }
                
                character = Character.objects.create(
                    book_id=book,
                    character_data=character_data
                )
                
                self.characters.append(character)
                book_characters.append(character)
            
            # Update relationships within the book
            for char in book_characters:
                relationships = []
                other_chars = [c for c in book_characters if c != char]
                for other_char in random.choices(other_chars, k=random.randint(1, 2)):
                    relationships.append(f"{other_char.name}: ุตุฏูู")
                
                char.character_data["relationships"] = relationships
                char.save()
                
        print(f"โ Created {len(self.characters)} characters!")

    def create_chunk_characters(self):
        """Create chunk-character relationships"""
        print("๐ Creating chunk-character relationships...")
        
        relationships_count = 0
        
        for book in self.books:
            book_chunks = list(book.chunks.all())
            book_characters = list(book.characters.all())
            
            for chunk in book_chunks:
                # Each chunk mentions 1-3 characters (without duplicates)
                num_mentions = random.randint(1, min(3, len(book_characters)))
                mentioned_characters = random.sample(
                    book_characters, 
                    k=num_mentions
                )
                
                for character in mentioned_characters:
                    ChunkCharacter.objects.create(
                        chunk_id=chunk,
                        character_id=character,
                        mention_count=random.randint(1, 5),
                        position_info={
                            "positions": [random.randint(0, len(chunk.chunk_text)) for _ in range(random.randint(1, 3))],
                            "context": "mentioned in narrative"
                        }
                    )
                    relationships_count += 1
                    
        print(f"โ Created {relationships_count} chunk-character relationships!")

    def create_character_relationships(self):
        """Create character relationships"""
        print("๐ Creating character relationships...")
        
        relationships_count = 0
        relationship_types = [
            'family', 'friend', 'enemy', 'romantic', 'colleague', 
            'mentor', 'ally', 'rival', 'other'
        ]
        
        for book in self.books:
            book_characters = list(book.characters.all())
            
            if len(book_characters) < 2:
                continue
                
            # Create relationships between characters in the same book
            for i, char1 in enumerate(book_characters):
                for char2 in book_characters[i+1:]:
                    # 50% chance to create a relationship
                    if random.random() < 0.5:
                        relationship_type = random.choice(relationship_types)
                        
                        CharacterRelationship.objects.create(
                            character_id_1=char1,
                            character_id_2=char2,
                            relationship_type=relationship_type,
                            description=f"{char1.name} ู {char2.name} ูุฏูููุง ุนูุงูุฉ {relationship_type}",
                            book_id=book
                        )
                        relationships_count += 1
                        
        print(f"โ Created {relationships_count} character relationships!")

    def print_summary(self):
        """Print summary of created data"""
        print("\n" + "="*50)
        print("๐ DATABASE SEEDING SUMMARY")
        print("="*50)
        print(f"๐ฅ Users: {User.objects.count()}")
        print(f"๐ Books: {Book.objects.count()}")
        print(f"๐ Chunks: {Chunk.objects.count()}")
        print(f"๐ค Characters: {Character.objects.count()}")
        print(f"๐ Chunk-Character relationships: {ChunkCharacter.objects.count()}")
        print(f"๐ Character relationships: {CharacterRelationship.objects.count()}")
        print("="*50)
        
        # Print some sample data
        print("\n๐ SAMPLE DATA:")
        print("-" * 30)
        
        sample_user = User.objects.first()
        if sample_user:
            print(f"Sample User: {sample_user.name} ({sample_user.email})")
            
        sample_book = Book.objects.first()
        if sample_book:
            print(f"Sample Book: {sample_book.title} by {sample_book.author}")
            
        sample_character = Character.objects.first()
        if sample_character:
            print(f"Sample Character: {sample_character.name} - {sample_character.role}")
            
        print("\n๐ Database seeding completed successfully!")

    def seed_all(self):
        """Run the complete seeding process"""
        print("๐ฑ Starting database seeding...")
        print("="*50)
        
        self.clear_database()
        self.create_users(10)
        self.create_books(8)
        self.create_chunks()
        self.create_characters()
        self.create_chunk_characters()
        self.create_character_relationships()
        self.print_summary()


if __name__ == "__main__":
    seeder = DatabaseSeeder()
    seeder.seed_all()
